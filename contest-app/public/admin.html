<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Admin Dashboard | Contest Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
      :root {
        --bg: #0d1117;
        --card: #161b22;
        --blue: #58a6ff;
        --border: #30363d;
        --text: #c9d1d9;
        --green: #238636;
        --red: #f85149;
      }
      body {
        background: var(--bg);
        color: var(--text);
        font-family: -apple-system, sans-serif;
        padding: 40px;
        margin: 0;
      }
      .container {
        max-width: 1100px;
        margin: 0 auto;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .header-actions {
        display: flex;
        gap: 10px;
      }

      .controls {
        display: flex;
        gap: 15px;
        align-items: center;
        margin-bottom: 20px;
        background: var(--card);
        padding: 15px;
        border-radius: 8px;
        border: 1px solid var(--border);
      }
      .search-input {
        padding: 10px 15px;
        background: #010409;
        border: 1px solid var(--border);
        border-radius: 6px;
        color: white;
        flex-grow: 1;
        outline: none;
      }

      .view-btn {
        background: #21262d;
        color: var(--text);
        border: 1px solid var(--border);
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
      }
      .view-btn.active {
        background: var(--blue);
        color: var(--bg);
        border-color: var(--blue);
      }

      #table-view,
      #chart-view {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 8px;
        overflow: hidden;
        padding: 20px;
        margin-top: 10px;
      }
      #chart-view {
        display: none;
        height: 500px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }
      th {
        background: #21262d;
        padding: 15px;
        text-align: left;
        color: var(--blue);
        border-bottom: 1px solid var(--border);
      }
      td {
        padding: 15px;
        border-bottom: 1px solid var(--border);
      }
      tr:hover {
        background: #1c2128;
      }

      .btn-refresh {
        background: var(--green);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
      }
      .btn-logout {
        background: transparent;
        color: var(--red);
        border: 1px solid var(--red);
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        transition: 0.2s;
      }
      .btn-logout:hover {
        background: var(--red);
        color: white;
      }

      .score-badge {
        color: var(--green);
        font-weight: bold;
        font-family: monospace;
        font-size: 1.1em;
      }
      .timestamp {
        font-size: 12px;
        color: #8b949e;
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Admin Control Panel</h1>
        <div class="header-actions">
          <button class="btn-refresh" onclick="loadData()">Refresh Data</button>
          <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
      </div>
      <div class="header" style="margin-top: 30px">
        <h3>Live Server Health</h3>
      </div>
      <div
        class="controls"
        id="status-panel"
        style="
          display: grid;
          grid-template-columns: repeat(3, 1fr);
          text-align: center;
        "
      >
        <div>
          <div style="font-size: 12px; color: var(--blue)">ACTIVE SESSIONS</div>
          <div id="stat-active" style="font-size: 24px; font-weight: bold">
            0
          </div>
        </div>
        <div>
          <div style="font-size: 12px; color: var(--green)">TOTAL REQUESTS</div>
          <div id="stat-reqs" style="font-size: 24px; font-weight: bold">0</div>
        </div>
        <div>
          <div style="font-size: 12px; color: var(--red)">THROTTLED IPS</div>
          <div id="stat-blocked" style="font-size: 24px; font-weight: bold">
            -
          </div>
        </div>
      </div>

      <div
        class="controls"
        style="flex-direction: column; align-items: flex-start; gap: 20px"
      >
        <div style="display: flex; gap: 15px; width: 100%">
          <div
            style="
              flex: 1;
              border: 1px dashed var(--border);
              padding: 15px;
              border-radius: 8px;
            "
          >
            <label
              style="
                display: block;
                margin-bottom: 10px;
                font-size: 12px;
                color: var(--blue);
              "
              >UPLOAD QUESTIONS.JSON</label
            >
            <input
              type="file"
              id="qFile"
              accept=".json"
              onchange="handleUpload('questions.json', 'qFile')"
            />
          </div>
          <div
            style="
              flex: 1;
              border: 1px dashed var(--border);
              padding: 15px;
              border-radius: 8px;
            "
          >
            <label
              style="
                display: block;
                margin-bottom: 10px;
                font-size: 12px;
                color: var(--red);
              "
              >UPLOAD ANSWERS.JSON (SECRET)</label
            >
            <input
              type="file"
              id="aFile"
              accept=".json"
              onchange="handleUpload('answers.json', 'aFile')"
            />
          </div>
        </div>

        <div style="display: flex; gap: 10px">
          <button
            class="btn-refresh"
            onclick="refreshConfig()"
            style="background: var(--blue)"
          >
            Manual Sync S3 to Memory
          </button>
          <span
            id="config-status"
            style="font-size: 13px; color: #8b949e; align-self: center"
          ></span>
        </div>
      </div>

      <div class="controls">
        <div style="display: flex; gap: 5px">
          <button
            id="btn-table"
            class="view-btn active"
            onclick="switchView('table')"
          >
            Table View
          </button>
          <button id="btn-chart" class="view-btn" onclick="switchView('chart')">
            Performance Graph
          </button>
        </div>
        <input
          type="text"
          id="teamSearch"
          class="search-input"
          placeholder="Search team name..."
          onkeyup="filterData()"
        />
      </div>

      <div id="table-view">
        <table>
          <thead>
            <tr>
              <th style="width: 40%">Team Name</th>
              <th style="width: 20%">Score</th>
              <th style="width: 40%">Submitted At</th>
            </tr>
          </thead>
          <tbody id="table-body">
            <tr>
              <td colspan="3" style="text-align: center; padding: 40px">
                Fetching records...
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="chart-view">
        <canvas id="scoreChart"></canvas>
      </div>
    </div>

    <script>
      let allSubmissions = [];
      let myChart = null;

      // --- AUTH LOGIC ---
      async function logout() {
        try {
          // 1. Tell the server to kill the session
          const response = await fetch("/api/admin/logout", { method: "POST" });

          if (response.ok) {
            // 2. ONLY redirect after the server confirms it's done
            window.location.href = "/admin";
          }
        } catch (err) {
          console.error("Logout failed", err);
        }
      }

      // --- DATA LOADING ---
      async function loadData() {
        try {
          const res = await fetch("/api/admin/submissions");
          if (res.status === 401) return (window.location.href = "/admin");
          allSubmissions = await res.json();
          updateDisplay(allSubmissions);
        } catch (e) {
          document.getElementById("table-body").innerHTML =
            '<tr><td colspan="3" style="text-align: center; color: var(--red)">Error connecting to server</td></tr>';
        }
      }

      // --- S3 OPERATIONS ---
      async function handleUpload(filename, inputId) {
        const file = document.getElementById(inputId).files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const content = JSON.parse(e.target.result);
            const res = await fetch("/api/admin/upload-config", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ filename, content }),
            });
            const result = await res.json();
            alert(res.ok ? result.message : result.error);
          } catch (err) {
            alert("Invalid JSON file");
          }
        };
        reader.readAsText(file);
      }

      async function refreshConfig() {
        const res = await fetch("/api/admin/refresh-config", {
          method: "POST",
        });
        const data = await res.json();
        if (res.ok)
          alert(
            "Server memory updated! Loaded " + data.questions + " questions."
          );
      }

      // --- UI LOGIC ---
      function switchView(view) {
        document.getElementById("table-view").style.display =
          view === "table" ? "block" : "none";
        document.getElementById("chart-view").style.display =
          view === "chart" ? "block" : "none";
        document
          .getElementById("btn-table")
          .classList.toggle("active", view === "table");
        document
          .getElementById("btn-chart")
          .classList.toggle("active", view === "chart");
        if (view === "chart") renderChart(allSubmissions);
      }

      function updateDisplay(data) {
        renderTable(data);
        if (document.getElementById("chart-view").style.display === "block")
          renderChart(data);
      }

      function renderTable(data) {
        const tbody = document.getElementById("table-body");
        tbody.innerHTML = data.length
          ? ""
          : '<tr><td colspan="3" style="text-align:center;">No records found.</td></tr>';
        data.forEach((sub) => {
          const row = document.createElement("tr");
          const date = new Date(sub.submittedAt);
          row.innerHTML = `
                    <td style="font-weight:bold; color:white;">${sub.teamName.toUpperCase()}</td>
                    <td><span class="score-badge">${sub.score ?? 0}</span></td>
                    <td><span class="timestamp">${date.toLocaleDateString()}</span> ${date.toLocaleTimeString()}</td>
                `;
          tbody.appendChild(row);
        });
      }

      function renderChart(data) {
        const ctx = document.getElementById("scoreChart").getContext("2d");
        if (myChart) myChart.destroy();

        // 1. Group data by Team Name
        const teams = {};
        const allTimestamps = new Set();

        data.forEach((sub) => {
          const team = sub.teamName.toUpperCase();
          if (!teams[team]) teams[team] = [];

          const timestamp = new Date(sub.submittedAt).getTime();
          teams[team].push({ x: timestamp, y: sub.score || 0 });
          allTimestamps.add(timestamp);
        });

        // 2. Sort timestamps for the X-axis labels
        const sortedLabels = Array.from(allTimestamps).sort((a, b) => a - b);

        // 3. Create a dataset for each team
        const colors = [
          "#58a6ff",
          "#238636",
          "#f85149",
          "#d29922",
          "#bc8cff",
          "#fa7a18",
        ];
        const datasets = Object.keys(teams).map((teamName, index) => {
          return {
            label: teamName,
            data: teams[teamName].sort((a, b) => a.x - b.x), // Ensure points are in time order
            borderColor: colors[index % colors.length],
            backgroundColor: colors[index % colors.length] + "33", // Add transparency
            tension: 0.3, // Makes the line curved
            fill: false,
            pointRadius: 5,
            pointHoverRadius: 7,
          };
        });

        // 4. Initialize Chart.js Line Chart
        myChart = new Chart(ctx, {
          type: "line",
          data: { datasets },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: "index",
              intersect: false,
            },
            plugins: {
              legend: {
                display: true,
                position: "top",
                labels: { color: "#c9d1d9" },
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    return `${context.dataset.label}: ${context.parsed.y} points`;
                  },
                  title: function (context) {
                    return new Date(context[0].parsed.x).toLocaleString();
                  },
                },
              },
            },
            scales: {
              x: {
                type: "linear", // Use linear to handle Unix timestamps
                position: "bottom",
                grid: { color: "#30363d" },
                ticks: {
                  color: "#8b949e",
                  callback: function (value) {
                    return new Date(value).toLocaleTimeString([], {
                      hour: "2-digit",
                      minute: "2-digit",
                    });
                  },
                },
              },
              y: {
                beginAtZero: true,
                grid: { color: "#30363d" },
                ticks: { color: "#8b949e" },
              },
            },
          },
        });
      }

      async function updateStats() {
        try {
          // You'll need an endpoint in your Node app that fetches from http://nginx-shield/nginx_status
          const res = await fetch("/api/admin/server-stats");
          const text = await res.text();

          // Nginx stub_status parsing
          const activeMatch = text.match(/Active connections: (\d+)/);
          const reqsMatch = text.match(/\s+(\d+)\s+(\d+)\s+(\d+)/);

          if (activeMatch)
            document.getElementById("stat-active").innerText = activeMatch[1];
          if (reqsMatch)
            document.getElementById("stat-reqs").innerText = reqsMatch[3];
        } catch (e) {
          console.log("Stats update failed. Ensure proxy is configured.");
        }
      }

      // Call this inside your existing loadData or setInterval
      setInterval(updateStats, 5000);
      function filterData() {
        const term = document.getElementById("teamSearch").value.toUpperCase();
        const filtered = allSubmissions.filter((s) =>
          s.teamName.toUpperCase().includes(term)
        );
        updateDisplay(filtered);
      }

      loadData();
      setInterval(loadData, 90000);
    </script>
  </body>
</html>
